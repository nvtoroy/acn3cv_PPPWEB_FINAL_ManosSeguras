<main class="panel-pro">
    <section class="panel-hero">
        <div>
            <p class="eyebrow">Mi Perfil</p>
            <h1><%= user.nombre %></h1>
            <p class="lead"><%= currentUser.rol === 'profesional' && professional ? professional.descripcion : 'Bienvenido a tu panel de control.' %></p>
            <div class="hero-tags">
                <% if (currentUser.rol === 'profesional' && professional && professional.verificado) { %>
                    <span class="status-pill success">Perfil verificado</span>
                <% } %>
                <% if (currentUser.rol === 'profesional' && professional) { %>
                    <span class="status-pill"><%= professional.experiencia || 0 %> años activo en ManosSeguras</span>
                <% } else { %>
                    <span class="status-pill"><%= currentUser.rol.charAt(0).toUpperCase() + currentUser.rol.slice(1) %></span>
                <% } %>
            </div>
        </div>
        <div class="hero-stats">
            <% if (currentUser.rol === 'profesional' && professional) { %>
                <div class="stat-block">
                    <p class="stat-label">Trabajos finalizados</p>
                    <p class="stat-value"><%= professional.trabajos_completados || 0 %></p>
                </div>
                <div class="stat-block">
                    <p class="stat-label">Solicitudes abiertas</p>
                    <p class="stat-value"><%= typeof solicitudesAbiertas !== 'undefined' ? solicitudesAbiertas : 0 %></p>
                </div>
                <div class="stat-block">
                    <p class="stat-label">Calificación promedio</p>
                    <p class="stat-value"><%= professional.calificacion_promedio ? professional.calificacion_promedio.toFixed(1) : '0.0' %></p>
                </div>
            <% } else { %>
                <div class="stat-block">
                    <p class="stat-label">Mis solicitudes</p>
                    <p class="stat-value"><%= solicitudes ? solicitudes.length : 0 %></p>
                </div>
            <% } %>
        </div>
    </section>

    <section class="panel-tabs">
        <button class="tab-link active" type="button" data-tab="solicitudes">Solicitudes</button>
        <% if (currentUser.rol === 'profesional') { %>
            <button class="tab-link" type="button" data-tab="calendario">Calendario</button>
        <% } %>
        <button class="tab-link" type="button" data-tab="datos-personales">Datos personales</button>
        <button class="tab-link" type="button" data-tab="seguridad">Seguridad</button>
        <% if (currentUser.rol === 'profesional') { %>
            <button class="tab-link" type="button" data-tab="servicios">Servicios</button>
            <button class="tab-link" type="button" data-tab="certificaciones">Certificaciones</button>
            <button class="tab-link" type="button" data-tab="zona">Zona de trabajo</button>
        <% } %>
    </section>

    <section class="panel-grid">
        <!-- Solicitudes -->
        <article class="panel-card wide tab-panel active" id="solicitudes">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h2>Solicitudes y chat</h2>
                    <p>Todos los pedidos quedan registrados y sirven como garantía.</p>
                </div>
            </div>
            <div class="solicitudes-lista">
                <% if (solicitudes && solicitudes.length > 0) { %>
                    <% solicitudes.forEach(function(sol) { %>
                        <div class="solicitud-card">
                            <div class="solicitud-head">
                                <div>
                                    <h4><%= sol.tipo_servicio || 'Servicio' %></h4>
                                    <p><%= currentUser.rol === 'profesional' ? (sol.cliente_nombre || 'Cliente') : (sol.profesional_nombre || 'Profesional') %> • <%= sol.fecha_preferida ? 'Fecha sugerida ' + new Date(sol.fecha_preferida).toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit'}) : 'Sin fecha' %></p>
                                </div>
                                <span class="status-pill <%= estadoBadgeClass(sol.estado) %>"><%= translateEstado(sol.estado) %></span>
                            </div>
                            <div class="solicitud-chat">
                                <div class="chat-row">
                                    <span class="chat-author">Cliente</span>
                                    <p><%= sol.descripcion %></p>
                                </div>
                                <% if (sol.ultimo_mensaje) { %>
                                <div class="chat-row professional">
                                    <span class="chat-author"><%= currentUser.rol === 'profesional' ? user.nombre.split(' ')[0] + ' (vos)' : (sol.profesional_nombre ? sol.profesional_nombre.split(' ')[0] : 'Profesional') %></span>
                                    <p><%= sol.ultimo_mensaje %></p>
                                </div>
                                <% } %>
                            </div>
                            <div class="solicitud-actions">
                                <% if (currentUser.rol === 'profesional' && sol.estado === 'pendiente') { %>
                                    <form method="POST" action="/solicitudes/<%= sol.id %>/estado" style="display:inline;">
                                        <input type="hidden" name="estado" value="aceptada">
                                        <button type="submit" class="btn btn-outline">Aceptar trabajo</button>
                                    </form>
                                    <form method="POST" action="/solicitudes/<%= sol.id %>/estado" style="display:inline;">
                                        <input type="hidden" name="estado" value="rechazada">
                                        <button type="submit" class="btn btn-outline">Rechazar</button>
                                    </form>
                                <% } %>
                                <a href="/solicitudes/<%= sol.id %>" class="btn-link"><%= sol.estado === 'pendiente' ? 'Abrir solicitud completa' : 'Ver conversación' %></a>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="empty-state">No tenés solicitudes activas.</p>
                <% } %>
            </div>
        </article>

        <% if (currentUser.rol === 'profesional') { %>
        <!-- Calendario -->
        <article class="panel-card wide tab-panel" id="calendario">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h2>Calendario manual</h2>
                    <p>Mantené tres meses a la vista y actualizá tu disponibilidad manualmente.</p>
                </div>
            </div>
            <form class="pro-calendar" data-multi-calendar method="POST" action="/profile/availability">
                <input type="hidden" name="slots" id="slots-input">
                <div class="calendar-controls">
                    <button class="cal-btn" data-cal-prev aria-label="Mes anterior" type="button">&larr;</button>
                    <h3 class="calendar-range" data-cal-range>Diciembre 2025 - Febrero 2026</h3>
                    <button class="cal-btn" data-cal-next aria-label="Mes siguiente" type="button">&rarr;</button>
                </div>
                <div class="calendar-columns" data-calendar-columns>
                    <!-- columnas generadas por script -->
                </div>
                <div class="calendar-legend">
                    <span><span class="legend-dot free"></span> Disponible</span>
                    <span><span class="legend-dot busy"></span> Reservado</span>
                    <span><span class="legend-dot past"></span> Pasado</span>
                </div>
                <div class="form-actions" style="margin-top:1rem;">
                    <button type="submit" class="btn btn-primary">Guardar disponibilidad</button>
                </div>
            </form>
        </article>
        <% } %>

        <!-- Datos personales -->
        <article class="panel-card wide tab-panel" id="datos-personales">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h2>Datos personales</h2>
                    <p>Actualizá tu información básica. Se mostrará en tu perfil público.</p>
                </div>
            </div>
            <form class="panel-form" method="POST" action="/profile/update">
                <input type="hidden" name="tab" value="datos-personales">
                <div class="avatar-block">
                    <% if (user.avatar) { %>
                        <img src="<%= user.avatar %>" alt="Avatar" class="avatar">
                    <% } else { %>
                        <div class="avatar perfil-avatar-placeholder"><%= user.nombre.charAt(0).toUpperCase() %></div>
                    <% } %>
                    <div>
                        <label class="btn-outline small">
                            URL de foto
                            <input type="url" name="avatar_url" value="<%= user.avatar || '' %>" placeholder="https://..." style="margin-top:0.35rem;">
                        </label>
                        <p class="help-text">Ingresa URL a tu foto (PNG/JPG)</p>
                    </div>
                </div>
                <div class="form-row">
                    <label>Nombre
                        <input type="text" name="nombre" value="<%= user.nombre.split(' ')[0] || '' %>" />
                    </label>
                    <label>Apellido
                        <input type="text" name="apellido" value="<%= user.nombre.split(' ').slice(1).join(' ') || '' %>" />
                    </label>
                </div>
                <div class="form-row">
                    <label>Email
                        <input type="email" value="<%= user.email %>" disabled />
                    </label>
                    <label>Teléfono
                        <input type="tel" name="telefono" value="<%= user.telefono || '' %>" />
                    </label>
                </div>
                <% if (currentUser.rol === 'profesional' && professional) { %>
                <label>Descripción profesional
                    <textarea name="descripcion" rows="4"><%= professional.descripcion || '' %></textarea>
                </label>
                <div class="form-row">
                    <label>Años de experiencia
                        <input type="number" name="experiencia" value="<%= professional.experiencia || 0 %>" />
                    </label>
                    <label>Especialidad principal
                        <select name="especialidad">
                            <option value="electricista" <%= professional.especialidad === 'electricista' ? 'selected' : '' %>>Electricista</option>
                            <option value="plomero" <%= professional.especialidad === 'plomero' ? 'selected' : '' %>>Plomero</option>
                            <option value="gasista" <%= professional.especialidad === 'gasista' ? 'selected' : '' %>>Gasista</option>
                        </select>
                    </label>
                </div>
                <label>Zona de cobertura
                    <input type="text" name="zona_cobertura" value="<%= professional.zona_cobertura || '' %>" placeholder="Ej: CABA y GBA Norte" />
                </label>
                <% } else { %>
                <label>Dirección
                    <input type="text" name="direccion" value="<%= user.direccion || '' %>" />
                </label>
                <% } %>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline">Descartar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </article>

        <!-- Seguridad -->
        <article class="panel-card tab-panel" id="seguridad">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h3>Seguridad y accesos</h3>
                    <p>Mantené tus datos protegidos.</p>
                </div>
            </div>
            <form class="panel-form compact" method="POST" action="/profile/password">
                <input type="hidden" name="tab" value="seguridad">
                <label>Email de acceso
                    <input type="email" value="<%= user.email %>" disabled>
                </label>
                <label>Contraseña actual
                    <input type="password" name="current_password" placeholder="••••••••">
                </label>
                <div class="form-row">
                    <label>Nueva contraseña
                        <input type="password" name="new_password" placeholder="••••••">
                    </label>
                    <label>Confirmar
                        <input type="password" name="confirm_password" placeholder="••••••">
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </article>

        <% if (currentUser.rol === 'profesional' && professional) { %>
        <!-- Servicios -->
        <article class="panel-card tab-panel" id="servicios">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h3>Servicios y tarifas</h3>
                    <p>Define qué trabajos ofrecés.</p>
                </div>
            </div>
            <div class="servicios-lista">
                <% if (services && services.length) { %>
                    <% services.forEach(function(serv) { %>
                        <div class="servicio-row">
                            <div>
                                <h4><%= serv.nombre %></h4>
                                <p>
                                    <%= serv.precio_desde ? '$' + serv.precio_desde : 'A convenir' %>
                                    <% if (serv.precio_hasta) { %> - $<%= serv.precio_hasta %><% } %>
                                </p>
                            </div>
                            <div class="row-actions">
                                <form method="POST" action="/profile/servicios/<%= serv.id %>/delete">
                                    <button class="btn-link danger" type="submit">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="empty-state">No cargaste servicios aún.</p>
                <% } %>
            </div>
            <form class="panel-form" method="POST" action="/profile/servicios">
                <input type="hidden" name="tab" value="servicios">
                <div class="form-row">
                    <label>Nombre
                        <input type="text" name="nombre" required placeholder="Ej: Instalación eléctrica completa">
                    </label>
                    <label>Precio desde
                        <input type="number" step="0.01" name="precio_desde" placeholder="15000">
                    </label>
                    <label>Precio hasta
                        <input type="number" step="0.01" name="precio_hasta" placeholder="50000">
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Agregar servicio</button>
                </div>
            </form>
        </article>

        <!-- Certificaciones -->
        <article class="panel-card tab-panel" id="certificaciones">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h3>Certificaciones</h3>
                    <p>Documentos verificados por el administrador.</p>
                </div>
            </div>
            <ul class="checklist">
                <% if (certificaciones && certificaciones.length > 0) { %>
                    <% certificaciones.forEach(function(cert) { %>
                        <li>
                            <div>
                                <strong><%= cert.nombre %></strong>
                                <p><%= cert.archivo || 'Documento cargado' %></p>
                            </div>
                            <form method="POST" action="/profile/certificaciones/<%= cert.id %>/delete">
                                <button class="btn-link danger" type="submit">Eliminar</button>
                            </form>
                        </li>
                    <% }); %>
                <% } else { %>
                    <li>
                        <div>
                            <strong>Sin certificaciones cargadas</strong>
                            <p>Agregá tus credenciales para verificación.</p>
                        </div>
                        <span class="status-pill">Pendiente</span>
                    </li>
                <% } %>
            </ul>
            <form class="panel-form" method="POST" action="/profile/certificaciones">
                <input type="hidden" name="tab" value="certificaciones">
                <div class="form-row">
                    <label>Nombre
                        <input type="text" name="nombre" required placeholder="Ej: Matrícula profesional">
                    </label>
                    <label>Archivo / URL
                        <input type="text" name="archivo" placeholder="certificaciones/matricula.pdf o https://...">
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Agregar certificación</button>
                </div>
            </form>
        </article>

        <!-- Zona de trabajo -->
        <article class="panel-card tab-panel" id="zona">
            <div class="card-header">
                <span class="marker"></span>
                <div>
                    <h3>Zona de trabajo</h3>
                    <p>Los clientes verán este radio de cobertura.</p>
                </div>
            </div>
            <form class="panel-form" method="POST" action="/profile/update">
                <input type="hidden" name="tab" value="zona">
                <div class="zona-info">
                    <p><strong>Zona actual:</strong> <%= professional.zona_cobertura || 'No definida' %></p>
                </div>
                <label>Zona de cobertura
                    <input type="text" name="zona_cobertura" value="<%= professional.zona_cobertura || '' %>" placeholder="Ej: CABA y GBA Norte">
                </label>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Guardar zona</button>
                </div>
            </form>
        </article>
        <% } %>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-link');
    const tabPanels = document.querySelectorAll('.tab-panel');

    const showPanel = (panelId) => {
        tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === panelId));
        tabPanels.forEach(panel => panel.classList.toggle('active', panel.id === panelId));
    };

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => showPanel(btn.dataset.tab));
    });

    const initial = document.querySelector('.tab-link.active');
    if (initial) {
        showPanel(initial.dataset.tab);
    }

    // Calendario script
    const calendar = document.querySelector('[data-multi-calendar]');
    if (calendar) {
        const columnsEl = calendar.querySelector('[data-calendar-columns]');
        const rangeEl = calendar.querySelector('[data-cal-range]');
        const prevBtn = calendar.querySelector('[data-cal-prev]');
        const nextBtn = calendar.querySelector('[data-cal-next]');
        const monthNames = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
        const today = new Date();
        today.setHours(0,0,0,0);
        let centerMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        const availability = {};
        let hasAvailability = false;
        <% if (availability && availability.length) { %>
            <% availability.forEach(function(slot){ %>
                availability["<%= slot.fecha %>"] = "<%= slot.estado %>";
            <% }); %>
            hasAvailability = true;
        <% } %>

        const formatMonth = (date) => `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

        const cycleStatus = (current) => {
            if (current === 'free') return 'busy';
            if (current === 'busy') return '';
            return 'free';
        };

        const render = () => {
            columnsEl.innerHTML = '';
            const startRange = new Date(centerMonth.getFullYear(), centerMonth.getMonth() - 1, 1);
            const endRange = new Date(centerMonth.getFullYear(), centerMonth.getMonth() + 1, 1);
            rangeEl.textContent = `${formatMonth(startRange)} - ${formatMonth(endRange)}`;

            for (let offset = -1; offset <= 1; offset++) {
                const date = new Date(centerMonth.getFullYear(), centerMonth.getMonth() + offset, 1);
                const wrapper = document.createElement('div');
                wrapper.className = 'calendar-wrapper';
                const title = document.createElement('h4');
                title.textContent = formatMonth(date);
                wrapper.appendChild(title);

                const weekdays = document.createElement('div');
                weekdays.className = 'calendar-weekdays';
                ['L','M','M','J','V','S','D'].forEach(d => {
                    const span = document.createElement('span');
                    span.textContent = d;
                    weekdays.appendChild(span);
                });
                wrapper.appendChild(weekdays);

                const grid = document.createElement('div');
                grid.className = 'calendar-grid';
                const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const offsetStart = (firstDay.getDay() + 6) % 7;

                for (let i = 0; i < offsetStart; i++) {
                    const filler = document.createElement('span');
                    filler.className = 'calendar-day empty';
                    grid.appendChild(filler);
                }

                for (let day = 1; day <= lastDay; day++) {
                    const cell = document.createElement('span');
                    cell.className = 'calendar-day';
                    cell.textContent = day;
                    const iso = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const cellDate = new Date(date.getFullYear(), date.getMonth(), day);
                    const status = availability[iso];
                    if (status) {
                        cell.dataset.status = status;
                    }
                    if (cellDate < today) {
                        cell.classList.add('past');
                    } else {
                        cell.addEventListener('click', () => {
                            const nextStatus = cycleStatus(cell.dataset.status || '');
                            if (nextStatus) {
                                cell.dataset.status = nextStatus;
                                availability[iso] = nextStatus;
                            } else {
                                cell.removeAttribute('data-status');
                                delete availability[iso];
                            }
                        });
                    }
                    grid.appendChild(cell);
                }

                wrapper.appendChild(grid);
                columnsEl.appendChild(wrapper);
            }
        };

        prevBtn.addEventListener('click', () => {
            centerMonth.setMonth(centerMonth.getMonth() - 1);
            render();
        });

        nextBtn.addEventListener('click', () => {
            centerMonth.setMonth(centerMonth.getMonth() + 1);
            render();
        });

        render();

        // Guardar disponibilidad al enviar el formulario
        const slotsInput = document.getElementById('slots-input');
        calendar.addEventListener('submit', (e) => {
            if (!slotsInput) return;
            const entries = Object.entries(availability).map(([fecha, estado]) => ({ fecha, estado }));
            slotsInput.value = JSON.stringify(entries);
        });
    }
});
</script>
