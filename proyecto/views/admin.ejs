<main class="admin-container">
    <!-- Dashboard principal -->
    <section class="admin-header">
        <h1>Panel de Administración</h1>
        <p>Gestión de usuarios, profesionales y contenido de la plataforma</p>
    </section>

    <!-- Estadísticas -->
    <section class="admin-stats">
        <div class="stat-card">
            <div class="stat-icon" data-icon="US" aria-hidden="true"></div>
            <div class="stat-info">
                <h3><%= stats.totalUsers %></h3>
                <p>Usuarios Totales</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" data-icon="PR" aria-hidden="true"></div>
            <div class="stat-info">
                <h3><%= stats.totalProfessionals %></h3>
                <p>Profesionales Activos</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" data-icon="SL" aria-hidden="true"></div>
            <div class="stat-info">
                <h3><%= stats.unverifiedProfs %></h3>
                <p>Pendientes Verificar</p>
            </div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon" data-icon="RV" aria-hidden="true"></div>
            <div class="stat-info">
                <h3><%= stats.pendingReviews %></h3>
                <p>Reseñas Pendientes</p>
            </div>
        </div>
    </section>

    <section class="admin-tabs">
        <button class="admin-tab-link <%= activeTab === 'pendientes' ? 'active' : '' %>" data-admin-tab="pendientes">Pendientes</button>
        <button class="admin-tab-link <%= activeTab === 'usuarios' ? 'active' : '' %>" data-admin-tab="usuarios">Usuarios</button>
        <button class="admin-tab-link <%= activeTab === 'resenas' ? 'active' : '' %>" data-admin-tab="resenas">Reseñas</button>
    </section>

    <section class="admin-panels">
        <!-- Profesionales Pendientes -->
        <article class="admin-section admin-panel <%= activeTab === 'pendientes' ? 'active' : '' %>" id="pendientes">
            <h2>Profesionales Pendientes de Aprobación</h2>
            <div class="admin-table">
                <div class="table-row header-row">
                    <div class="col-photo">Foto</div>
                    <div class="col-name">Nombre</div>
                    <div class="col-specialty">Especialidad</div>
                    <div class="col-docs">Documentos</div>
                    <div class="col-actions">Acciones</div>
                </div>

                <% if (pendingProfessionals && pendingProfessionals.length > 0) { %>
                    <% pendingProfessionals.forEach(function(prof) { %>
                        <div class="table-row">
                            <div class="col-photo">
                                <% if (prof.foto_url) { %>
                                    <img src="<%= prof.foto_url %>" alt="Profesional" class="avatar-small">
                                <% } else { %>
                                    <div class="avatar-small avatar-placeholder"><%= prof.nombre.charAt(0) %></div>
                                <% } %>
                            </div>
                            <div class="col-name">
                                <strong><%= prof.nombre %></strong><br>
                                <small><%= prof.email %></small>
                            </div>
                            <div class="col-specialty">
                                <span class="badge badge-<%= prof.especialidad %>"><%= prof.especialidad %></span>
                            </div>
                            <div class="col-docs">
                                <span class="doc-link"><%= prof.experiencia %> años exp.</span>
                                <div><a href="/profesionales/<%= prof.id %>" class="btn-link">Ver perfil</a></div>
                            </div>
                            <div class="col-actions">
                                <form method="POST" action="/admin/profesionales/<%= prof.id %>/verificar" style="display: inline;">
                                    <input type="hidden" name="action" value="aprobar">
                                    <button type="submit" class="btn-approve">Aprobar</button>
                                </form>
                                <form method="POST" action="/admin/profesionales/<%= prof.id %>/verificar" style="display: inline;">
                                    <input type="hidden" name="action" value="rechazar">
                                    <button type="submit" class="btn-reject">Rechazar</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="table-row">
                        <div class="col-name" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                            No hay profesionales pendientes de aprobación.
                        </div>
                    </div>
                <% } %>
            </div>
            <% if (totalPendingPages > 1) { %>
                <div class="paginacion">
                    <% for (let i = 1; i <= totalPendingPages; i++) { %>
                        <a class="<%= i === currentPendingPage ? 'active' : '' %>" href="/admin?tab=pendientes&prof_page=<%= i %>&users_page=<%= currentUsersPage %>&rev_page=<%= currentReviewsPage %>&estado=<%= reviewsEstado %>"><%= i %></a>
                    <% } %>
                </div>
            <% } %>
        </article>

        <!-- Gestión de Usuarios -->
        <article class="admin-section admin-panel <%= activeTab === 'usuarios' ? 'active' : '' %>" id="usuarios">
            <h2>Gestión de Usuarios</h2>
            <div class="filters">
                <a class="filter-btn <%= !roleFilter ? 'active' : '' %>" href="/admin?tab=usuarios&rol=&users_page=1&prof_page=<%= currentPendingPage %>&rev_page=<%= currentReviewsPage %>&estado=<%= reviewsEstado %>">Todos</a>
                <a class="filter-btn <%= roleFilter === 'cliente' ? 'active' : '' %>" href="/admin?tab=usuarios&rol=cliente&users_page=1&prof_page=<%= currentPendingPage %>&rev_page=<%= currentReviewsPage %>&estado=<%= reviewsEstado %>">Clientes</a>
                <a class="filter-btn <%= roleFilter === 'profesional' ? 'active' : '' %>" href="/admin?tab=usuarios&rol=profesional&users_page=1&prof_page=<%= currentPendingPage %>&rev_page=<%= currentReviewsPage %>&estado=<%= reviewsEstado %>">Profesionales</a>
            </div>
            <div class="admin-table">
                <div class="table-row header-row">
                    <div class="col-name">Nombre</div>
                    <div class="col-email">Email</div>
                    <div class="col-type">Tipo</div>
                    <div class="col-date">Registro</div>
                    <div class="col-status">Estado</div>
                    <div class="col-actions">Acciones</div>
                </div>

                <% if (typeof users !== 'undefined' && users.length > 0) { %>
                    <% users.forEach(function(user) { %>
                        <div class="table-row">
                            <div class="col-name"><%= user.nombre %></div>
                            <div class="col-email"><%= user.email %></div>
                            <div class="col-type"><span class="badge badge-<%= user.rol %>"><%= user.rol %></span></div>
                            <div class="col-date"><%= new Date(user.created_at).toLocaleDateString('es-AR') %></div>
                            <div class="col-status"><span class="status-active">Activo</span></div>
                            <div class="col-actions">
                                <form method="POST" action="/admin/usuarios/<%= user.id %>/delete" style="display:inline;">
                                    <button class="btn-reject" type="submit">Eliminar</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
            <% if (totalUsersPages > 1) { %>
                <div class="paginacion">
                    <% for (let i = 1; i <= totalUsersPages; i++) { %>
                        <a class="<%= i === currentUsersPage ? 'active' : '' %>" href="/admin?tab=usuarios&users_page=<%= i %>&prof_page=<%= currentPendingPage %>&rev_page=<%= currentReviewsPage %>&estado=<%= reviewsEstado %>&rol=<%= roleFilter %>"><%= i %></a>
                    <% } %>
                </div>
            <% } %>
        </article>

        <!-- Moderación de Reseñas -->
        <article class="admin-section admin-panel <%= activeTab === 'resenas' ? 'active' : '' %>" id="resenas">
            <h2>Moderación de Reseñas</h2>
            <div class="filters">
                <a href="/admin?tab=resenas&estado=pendiente&rev_page=1&prof_page=<%= currentPendingPage %>&users_page=<%= currentUsersPage %>" class="filter-btn <%= reviewsEstado === 'pendiente' ? 'active' : '' %>">Pendientes</a>
                <a href="/admin?tab=resenas&estado=aprobada&rev_page=1&prof_page=<%= currentPendingPage %>&users_page=<%= currentUsersPage %>" class="filter-btn <%= reviewsEstado === 'aprobada' ? 'active' : '' %>">Aprobadas</a>
                <a href="/admin?tab=resenas&estado=rechazada&rev_page=1&prof_page=<%= currentPendingPage %>&users_page=<%= currentUsersPage %>" class="filter-btn <%= reviewsEstado === 'rechazada' ? 'active' : '' %>">Rechazadas</a>
            </div>
            <div class="reviews-list">
                <% if (pendingReviewsList && pendingReviewsList.length > 0) { %>
                    <% pendingReviewsList.forEach(function(review) { %>
                        <div class="review-card">
                            <div class="review-header">
                                <div class="review-info">
                                    <strong><%= review.cliente_nombre %></strong> &gt; <strong><%= review.profesional_nombre %></strong>
                                </div>
                                <div class="review-rating">
                                    <% for(let i = 1; i <= 5; i++) { %>
                                        <span class="star <%= i <= review.calificacion ? 'filled' : '' %>"></span>
                                    <% } %>
                                </div>
                            </div>
                            <p class="review-text">"<%= review.comentario %>"</p>
                            <div class="review-date">Publicado: <%= new Date(review.created_at).toLocaleDateString('es-AR') %></div>
                            <div class="review-actions">
                                <form method="POST" action="/admin/reviews/<%= review.id %>/moderar" style="display: inline;">
                                    <input type="hidden" name="action" value="aprobar">
                                    <button type="submit" class="btn-approve-review">Aprobar</button>
                                </form>
                                <form method="POST" action="/admin/reviews/<%= review.id %>/moderar" style="display: inline;">
                                    <input type="hidden" name="action" value="rechazar">
                                    <button type="submit" class="btn-hide-review">Ocultar</button>
                                </form>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>No hay reseñas pendientes de moderación.</p>
                <% } %>
            </div>
            <% if (totalReviewsPages > 1) { %>
                <div class="paginacion">
                    <% for (let i = 1; i <= totalReviewsPages; i++) { %>
                        <a class="<%= i === currentReviewsPage ? 'active' : '' %>" href="/admin?tab=resenas&rev_page=<%= i %>&estado=<%= reviewsEstado %>&prof_page=<%= currentPendingPage %>&users_page=<%= currentUsersPage %>"><%= i %></a>
                    <% } %>
                </div>
            <% } %>
        </article>
    </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
        const tabLinks = document.querySelectorAll('.admin-tab-link');
        const panels = document.querySelectorAll('.admin-panel');

        tabLinks.forEach(link => {
            link.addEventListener('click', function() {
                const targetTab = this.dataset.adminTab;

                tabLinks.forEach(l => l.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');

                // Actualizar parámetro tab en URL sin recarga
                const url = new URL(window.location.href);
                url.searchParams.set('tab', targetTab);
                // Reiniciar páginas al cambiar tab
                if (targetTab === 'usuarios') {
                    url.searchParams.set('users_page', 1);
                } else if (targetTab === 'pendientes') {
                    url.searchParams.set('prof_page', 1);
                } else if (targetTab === 'resenas') {
                    url.searchParams.set('rev_page', 1);
                }
                window.history.replaceState({}, '', url.toString());
            });
        });
    });
</script>
